server {
    # 1. Listen port and default index files
    listen 9044;
    server_name localhost;

    # 2. Set the single, consistent root directory for the app
    # This root contains the 'assets', 'icons', and 'pages' subdirectories.
    root /usr/share/nginx/html;
    index portal.html index.html; # Specify the index files inside the 'pages' directory

    # 3. GZIP improvements: add standard HTML type
    gzip on;
    gzip_types text/plain text/html text/css application/javascript application/json;

    # 4. API Proxy for the AI Backend (tm-ai-agent-backend)
    location /api/ {
        proxy_pass http://tm-ai-agent-backend:9043;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 5. Internal Login Route (Serving portal.html without redirecting)
    # This now explicitly serves the file from the /pages subdirectory.
    location = /login {
        try_files /pages/portal.html =404;
    }

    # 6. Asset Handling Block (Ensures assets and icons are served from the root)
    # This matches /assets/ and /icons/ paths used in the HTML files.
    location ~ ^/(assets|icons|scripts|styles|fonts)/ {
        try_files $uri =404;
    }

    # 7. Main Application Block (Handles HTML entry files and all other paths)
    location / {
        # Check if the requested URI maps to a physical file or directory (e.g., /admin.html).
        # If not, fall back to looking inside the /pages directory for the file.
        # If still not found, fall back to index.html inside /pages (for SPA routing).
        try_files $uri $uri/ /pages/$uri /pages/$uri/ /pages/index.html;
    }
}
