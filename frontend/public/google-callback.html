<!DOCTYPE html>
<html>
<head>
    <title>Google OAuth Callback - TURFMAPP</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 600px; 
            margin: 50px auto; 
            padding: 20px; 
            text-align: center;
        }
        .loading { color: #007cba; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <h1>Google Authentication</h1>
    <div id="status" class="loading">Processing authentication...</div>
    <div id="result"></div>

    <!-- Include required scripts -->
    <script src="scripts/supabase-client.js"></script>
    <script src="scripts/google-services.js"></script>

    <script>
        async function handleGoogleCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');

            if (error) {
                let returnUrl = localStorage.getItem('google-oauth-return-url') || 'test-google.html';
                const returnContext = localStorage.getItem('google-oauth-return-context') || 'test';
                localStorage.removeItem('google-oauth-return-url');
                localStorage.removeItem('google-oauth-return-context');

                document.getElementById('status').innerHTML =
                    '<div class="error">‚ùå Google authentication failed</div>';
                document.getElementById('result').innerHTML =
                    `<p>Error: ${error}</p><p><a href="${returnUrl}">‚Üê Back to ${returnContext === 'settings' ? 'Settings' : 'test page'}</a></p>`;
                return;
            }

            if (!code) {
                let returnUrl = localStorage.getItem('google-oauth-return-url') || 'test-google.html';
                const returnContext = localStorage.getItem('google-oauth-return-context') || 'test';
                localStorage.removeItem('google-oauth-return-url');
                localStorage.removeItem('google-oauth-return-context');

                document.getElementById('status').innerHTML =
                    '<div class="error">‚ùå No authorization code received</div>';
                document.getElementById('result').innerHTML =
                    `<p><a href="${returnUrl}">‚Üê Back to ${returnContext === 'settings' ? 'Settings' : 'test page'}</a></p>`;
                return;
            }

            // Wait for Supabase to initialize
            console.log('üîÑ Waiting for Supabase initialization...');
            let attempts = 0;
            while (!window.supabase && attempts < 100) {
                await new Promise(resolve => setTimeout(resolve, 50));
                attempts++;
            }

            if (!window.supabase) {
                console.error('‚ùå Supabase failed to initialize');
                document.getElementById('status').innerHTML =
                    '<div class="error">‚ùå TURFMAPP initialization failed</div>';
                let returnUrl = localStorage.getItem('google-oauth-return-url') || 'test-google.html';
                const returnContext = localStorage.getItem('google-oauth-return-context') || 'test';
                localStorage.removeItem('google-oauth-return-url');
                localStorage.removeItem('google-oauth-return-context');

                document.getElementById('result').innerHTML = `
                    <p>Unable to initialize TURFMAPP authentication.</p>
                    <p><a href="${returnUrl}">‚Üê Back to ${returnContext === 'settings' ? 'Settings' : 'test page'}</a></p>
                `;
                return;
            }

            console.log('‚úÖ Supabase initialized, checking session...');

            // Check if user is authenticated with TURFMAPP first
            if (!window.supabase.isSessionValid()) {
                document.getElementById('status').innerHTML =
                    '<div class="error">‚ùå TURFMAPP authentication required</div>';
                let returnUrl = localStorage.getItem('google-oauth-return-url') || 'test-google.html';
                const returnContext = localStorage.getItem('google-oauth-return-context') || 'test';
                localStorage.removeItem('google-oauth-return-url');
                localStorage.removeItem('google-oauth-return-context');

                document.getElementById('result').innerHTML = `
                    <p>You need to be logged into TURFMAPP before connecting Google services.</p>
                    <p><a href="portal.html">‚Üê Login to TURFMAPP first</a></p>
                    <p>Then return to: <a href="${returnUrl}">${returnContext === 'settings' ? 'Settings' : 'Google integration test'}</a></p>
                `;
                return;
            }
            
            try {
                // Handle the OAuth callback
                const result = await GoogleServices.handleGoogleCallback(code, state);
                
                document.getElementById('status').innerHTML = 
                    '<div class="success">‚úÖ Google authentication successful!</div>';
                
                // Determine where to redirect based on stored return URL or referrer
                let returnUrl = localStorage.getItem('google-oauth-return-url') || 'test-google.html';
                const returnContext = localStorage.getItem('google-oauth-return-context') || 'test';
                
                // Clean up localStorage
                localStorage.removeItem('google-oauth-return-url');
                localStorage.removeItem('google-oauth-return-context');
                
                // Fallback to referrer check if localStorage wasn't set
                if (returnUrl === 'test-google.html' && document.referrer.includes('settings.html')) {
                    returnUrl = 'settings.html';
                }
                
                document.getElementById('result').innerHTML = `
                    <p>Welcome, ${result.user_info.name || result.user_info.email}!</p>
                    <p>You can now access Gmail, Google Drive, and Calendar.</p>
                    <p><strong><a href="${returnUrl}">‚Üê Go back to ${returnContext === 'settings' ? 'Settings' : 'test Google features'}</a></strong></p>
                `;
                
                // Auto-redirect after 2 seconds
                setTimeout(() => {
                    window.location.href = returnUrl;
                }, 2000);
                
            } catch (error) {
                console.error('Callback error:', error);
                
                // Get return URL info for error cases too
                let returnUrl = localStorage.getItem('google-oauth-return-url') || 'test-google.html';
                const returnContext = localStorage.getItem('google-oauth-return-context') || 'test';
                localStorage.removeItem('google-oauth-return-url');
                localStorage.removeItem('google-oauth-return-context');
                
                // Check if it's an authentication error
                if (error.message.includes('Not authenticated') || error.message.includes('Invalid state')) {
                    document.getElementById('status').innerHTML = 
                        '<div class="error">‚ùå TURFMAPP session expired</div>';
                    document.getElementById('result').innerHTML = `
                        <p>Your TURFMAPP login session has expired.</p>
                        <p><a href="portal.html">‚Üê Login to TURFMAPP again</a></p>
                        <p>Then return to: <a href="${returnUrl}">${returnContext === 'settings' ? 'Settings' : 'Google integration test'}</a></p>
                    `;
                } else {
                    document.getElementById('status').innerHTML = 
                        '<div class="error">‚ùå Authentication processing failed</div>';
                    document.getElementById('result').innerHTML = 
                        `<p>Error: ${error.message}</p><p><a href="${returnUrl}">‚Üê Back to ${returnContext === 'settings' ? 'Settings' : 'test page'}</a></p>`;
                }
            }
        }
        
        // Process callback when page loads
        document.addEventListener('DOMContentLoaded', handleGoogleCallback);
    </script>
</body>
</html>