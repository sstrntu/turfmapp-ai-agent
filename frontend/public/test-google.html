<!DOCTYPE html>
<html>
<head>
    <title>Test Google Integration - TURFMAPP</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        .primary { background: #007cba; color: white; }
        .success { background: #28a745; color: white; }
        .warning { background: #ffc107; color: black; }
        .error { background: #dc3545; color: white; }
        .status { padding: 10px; margin: 10px 0; border-radius: 3px; }
        .message-item, .file-item, .event-item { 
            border: 1px solid #eee; padding: 10px; margin: 5px 0; border-radius: 3px; 
        }
        .messages-list, .files-list, .events-list { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>Google Services Integration Test</h1>
    
    <div class="section">
        <h2>Authentication</h2>
        <div id="auth-status" class="status">Checking authentication...</div>
        <button id="authenticate-btn" class="primary" onclick="authenticateGoogle()">
            Authenticate with Google
        </button>
        <button id="refresh-tokens-btn" class="warning" onclick="refreshTokens()" style="display:none">
            Refresh Tokens
        </button>
    </div>

    <div class="section">
        <h2>Gmail</h2>
        <button class="primary" onclick="loadGmailMessages()">Load Gmail Messages</button>
        <input type="text" id="gmail-query" placeholder="Search query (optional)" style="margin: 10px;">
        <div id="gmail-messages"></div>
    </div>

    <div class="section">
        <h2>Google Drive</h2>
        <button class="primary" onclick="loadDriveFiles()">Load Drive Files</button>
        <input type="text" id="drive-query" placeholder="Search query (optional)" style="margin: 10px;">
        <div id="drive-files"></div>
    </div>

    <div class="section">
        <h2>Google Calendar</h2>
        <button class="primary" onclick="loadCalendarEvents()">Load Calendar Events</button>
        <div id="calendar-events"></div>
    </div>

    <div class="section">
        <h2>Advanced Google Drive Operations</h2>
        
        <h3>Create Folder Structure</h3>
        <input type="text" id="folder-path" placeholder="e.g., Projects/Client Name/Documents" style="width: 300px;">
        <button class="primary" onclick="createFolder()">Create Folders</button>
        
        <h3>Upload File</h3>
        <input type="file" id="file-input" multiple>
        <input type="text" id="upload-folder" placeholder="Folder path (optional)" style="width: 300px;">
        <button class="primary" onclick="uploadFiles()">Upload to Drive</button>
        
        <h3>List Files in Folder</h3>
        <input type="text" id="list-folder" placeholder="Folder path" style="width: 300px;">
        <button class="primary" onclick="listFolderFiles()">List Files</button>
        
        <div id="drive-operations-result" style="margin-top: 20px;"></div>
    </div>

    <!-- Include required scripts -->
    <script src="scripts/supabase-client.js"></script>
    <script src="scripts/google-auth.js"></script>
    <script src="scripts/google-services.js"></script>

    <script>
        // Initialize and check auth status
        async function init() {
            try {
                // Check if user is authenticated with TURFMAPP
                if (!GoogleAuth.isAuthenticated()) {
                    document.getElementById('auth-status').innerHTML = 
                        '<div class="error">Please login to TURFMAPP first: <a href="/portal.html">Login</a></div>';
                    return;
                }

                // Check Google auth status
                const googleAuth = await GoogleServices.checkGoogleAuth();
                updateAuthStatus(googleAuth);
                
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('auth-status').innerHTML = 
                    `<div class="error">Initialization failed: ${error.message}</div>`;
            }
        }

        function updateAuthStatus(authData) {
            const statusDiv = document.getElementById('auth-status');
            const authBtn = document.getElementById('authenticate-btn');
            const refreshBtn = document.getElementById('refresh-tokens-btn');

            if (authData.has_tokens) {
                statusDiv.innerHTML = '<div class="success">‚úì Google services authenticated</div>';
                authBtn.style.display = 'none';
                refreshBtn.style.display = 'inline-block';
            } else {
                statusDiv.innerHTML = '<div class="warning">‚ö† Google authentication required</div>';
                authBtn.style.display = 'inline-block';
                refreshBtn.style.display = 'none';
            }
        }

        async function authenticateGoogle() {
            try {
                await GoogleServices.authenticateGoogle();
            } catch (error) {
                alert(`Authentication failed: ${error.message}`);
            }
        }

        async function refreshTokens() {
            try {
                const success = await GoogleServices.refreshGoogleTokens();
                if (success) {
                    alert('Tokens refreshed successfully');
                    const googleAuth = await GoogleServices.checkGoogleAuth();
                    updateAuthStatus(googleAuth);
                } else {
                    alert('Failed to refresh tokens');
                }
            } catch (error) {
                alert(`Token refresh failed: ${error.message}`);
            }
        }

        async function loadGmailMessages() {
            try {
                const query = document.getElementById('gmail-query').value;
                const result = await GoogleServices.getGmailMessages(query, 10);
                GoogleServices.displayGmailMessages(result.messages, 'gmail-messages');
            } catch (error) {
                document.getElementById('gmail-messages').innerHTML = 
                    `<div class="error">Failed to load Gmail messages: ${error.message}</div>`;
            }
        }

        async function loadDriveFiles() {
            try {
                const query = document.getElementById('drive-query').value;
                const result = await GoogleServices.getDriveFiles(query, 10);
                GoogleServices.displayDriveFiles(result.files, 'drive-files');
            } catch (error) {
                document.getElementById('drive-files').innerHTML = 
                    `<div class="error">Failed to load Drive files: ${error.message}</div>`;
            }
        }

        async function loadCalendarEvents() {
            try {
                const result = await GoogleServices.getCalendarEvents('primary', 10);
                GoogleServices.displayCalendarEvents(result.events, 'calendar-events');
            } catch (error) {
                document.getElementById('calendar-events').innerHTML = 
                    `<div class="error">Failed to load Calendar events: ${error.message}</div>`;
            }
        }

        // Advanced Drive Operations
        async function createFolder() {
            try {
                const folderPath = document.getElementById('folder-path').value;
                if (!folderPath) {
                    alert('Please enter a folder path');
                    return;
                }

                const result = await GoogleServices.createFolderStructure(folderPath);
                document.getElementById('drive-operations-result').innerHTML = 
                    `<div class="success">‚úÖ Created: ${result.folder_path} (ID: ${result.folder_id})</div>`;
                
            } catch (error) {
                document.getElementById('drive-operations-result').innerHTML = 
                    `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function uploadFiles() {
            try {
                const fileInput = document.getElementById('file-input');
                const folderPath = document.getElementById('upload-folder').value || null;
                
                if (!fileInput.files.length) {
                    alert('Please select files to upload');
                    return;
                }

                const results = [];
                for (const file of fileInput.files) {
                    try {
                        const result = await GoogleServices.uploadToDrive(file, folderPath);
                        results.push(`‚úÖ ${file.name}: ${result.action} (${result.file.id})`);
                    } catch (error) {
                        results.push(`‚ùå ${file.name}: ${error.message}`);
                    }
                }

                document.getElementById('drive-operations-result').innerHTML = 
                    `<div class="success"><strong>Upload Results:</strong><br>${results.join('<br>')}</div>`;
                
            } catch (error) {
                document.getElementById('drive-operations-result').innerHTML = 
                    `<div class="error">‚ùå Upload Error: ${error.message}</div>`;
            }
        }

        async function listFolderFiles() {
            try {
                const folderPath = document.getElementById('list-folder').value;
                if (!folderPath) {
                    alert('Please enter a folder path');
                    return;
                }

                const result = await GoogleServices.listFilesInFolder(folderPath);
                
                if (result.files && result.files.length > 0) {
                    const fileList = result.files.map(file => 
                        `üìÑ ${file.name} (${file.size ? formatFileSize(file.size) : 'Unknown size'})`
                    ).join('<br>');
                    
                    document.getElementById('drive-operations-result').innerHTML = 
                        `<div class="success"><strong>Files in ${folderPath}:</strong><br>${fileList}</div>`;
                } else {
                    document.getElementById('drive-operations-result').innerHTML = 
                        `<div class="warning">No files found in ${folderPath}</div>`;
                }
                
            } catch (error) {
                document.getElementById('drive-operations-result').innerHTML = 
                    `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>